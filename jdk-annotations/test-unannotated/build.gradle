plugins {
    id "java-library"
}

dependencies {
    compileOnly deps.apt.autoService
    annotationProcessor deps.apt.autoService
    compileOnly project(":nullaway")
    api deps.build.jspecify
    implementation project(":jdk-annotations:test-annotated")
}

jar.dependsOn(project(':jdk-annotations:test-annotated').tasks.named('generateAstubx'))

def astubxPath = "${rootProject.projectDir}/jdk-annotations/test-annotated/build/generated/astubx/output.astubx"

jar {
    manifest {
        attributes(
                'Created-By'     : "Gradle ${gradle.gradleVersion}",
                'Build-Jdk'      : "${System.properties['java.version']} (${System.properties['java.vendor']} ${System.properties['java.vm.version']})",
                'Build-OS'       : "${System.properties['os.name']} ${System.properties['os.arch']} ${System.properties['os.version']}"
                )
    }
}

jar.doLast {
    def jarFile = jar.archiveFile.get().asFile
    def astubxFile = file(astubxPath)

    exec {
        workingDir "./build/libs"
        commandLine "jar", "uf", jar.archiveFile.get(), astubxFile.absolutePath
    }
}
